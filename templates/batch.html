{% extends 'base.html' %}
{% block content %}
<div class="animate__fadeInUp">
    <h1 class="mb-4" style="font-family: 'Cormorant Garamond', serif; font-size: 2.5rem;">Batch Document Generator</h1>
    <p class="text-muted mb-4" style="font-size: 1.1rem;">Select multiple templates to generate all documents with one form submission. All documents will be combined into a ZIP file for easy download.</p>

    <div class="row">
        <!-- Template Selection Column -->
        <div class="col-md-5">
            <div class="card mb-4" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1);">
                <div class="card-header" style="background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h5 class="mb-0">Select Templates</h5>
                </div>
                <div class="card-body">
                    <!-- Filter by Type -->
                    <div class="mb-3">
                        <label class="form-label">Filter by Type:</label>
                        <select id="type_filter" class="form-select" style="background: rgba(15, 23, 42, 0.8); border-color: var(--muted);">
                            <option value="">All Types</option>
                            {% for type in types %}
                                <option value="{{ type }}">{{ type|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Template Checkboxes -->
                    <div class="mb-3">
                        <label class="form-label">Templates:</label>
                        <div id="template_checkboxes" class="template-list" style="max-height: 300px; overflow-y: auto;">
                            {% for template in templates %}
                            <div class="form-check template-item" data-type="{{ template.type }}" style="margin-bottom: 0.75rem;">
                                <input class="form-check-input template-checkbox" type="checkbox" 
                                       value="{{ template.id }}" id="template_{{ template.id }}">
                                <label class="form-check-label" for="template_{{ template.id }}" 
                                       style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">
                                    <strong>{{ template.name }}</strong>
                                    <span class="badge ms-2" style="background: linear-gradient(45deg, #6dd5ed, #2a8bf2); font-size: 0.7rem;">{{ template.type|capitalize }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Selected Count -->
                    <div class="alert alert-info" role="alert" id="selection_info" style="background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.3); color: var(--success); display: none;">
                        <span id="selected_count">0</span> template(s) selected
                    </div>
                    
                    <button type="button" id="load_placeholders_btn" class="btn btn-primary w-100" disabled
                            style="padding: 0.75rem; font-size: 1rem; background: linear-gradient(45deg, #6dd5ed, #2a8bf2);">
                        Load Combined Form
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Form Column -->
        <div class="col-md-7">
            <div id="form_container" style="display: none;">
                <div class="card" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <h5 class="mb-0">Fill Details for All Selected Documents</h5>
                        <small class="text-muted">These inputs will be applied to all selected templates</small>
                    </div>
                    <div class="card-body">
                        <form id="batch_form" method="POST" action="/batch-generate" class="needs-validation" novalidate>
                            <div id="placeholders_container" class="row g-3">
                                <!-- Placeholders will be loaded here -->
                            </div>
                            
                            <div class="mt-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <button type="submit" class="btn btn-success w-100" 
                                                style="padding: 1rem; font-size: 1.1rem; background: linear-gradient(45deg, #22c55e, #16a34a);">
                                            <i class="fas fa-download"></i> Generate & Download ZIP
                                        </button>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="/" class="btn btn-secondary w-100" 
                                           style="padding: 1rem; font-size: 1.1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);">
                                            Back to Home
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-warning w-100" onclick="clearForm()"
                                                style="padding: 1rem; font-size: 1.1rem; background: linear-gradient(45deg, #f59e0b, #d97706);">
                                            Clear Form
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden field for template IDs -->
                            <input type="hidden" id="selected_template_ids" name="template_ids" value="">
                        </form>
                    </div>
                </div>
                
                <!-- Selected Templates Info -->
                <div class="card mt-4" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.8);">
                        <h6 class="mb-0">Selected Templates Summary</h6>
                    </div>
                    <div class="card-body" id="templates_summary">
                        <!-- Template summary will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    let selectedTemplates = [];
    
    // Type filter functionality
    $('#type_filter').change(function() {
        var selectedType = $(this).val();
        $('.template-item').each(function() {
            if (selectedType === '' || $(this).data('type') === selectedType) {
                $(this).show();
            } else {
                $(this).hide();
                $(this).find('input[type="checkbox"]').prop('checked', false);
            }
        });
        updateSelection();
    });
    
    // Template selection handling
    $('.template-checkbox').change(function() {
        updateSelection();
    });
    
    function updateSelection() {
        selectedTemplates = [];
        $('.template-checkbox:checked').each(function() {
            selectedTemplates.push($(this).val());
        });
        
        $('#selected_count').text(selectedTemplates.length);
        
        if (selectedTemplates.length > 0) {
            $('#selection_info').show();
            $('#load_placeholders_btn').prop('disabled', false);
        } else {
            $('#selection_info').hide();
            $('#load_placeholders_btn').prop('disabled', true);
            $('#form_container').hide();
        }
        
        $('#selected_template_ids').val(selectedTemplates.join(','));
    }
    
    // Load placeholders for selected templates
    $('#load_placeholders_btn').click(function() {
        if (selectedTemplates.length === 0) return;
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');
        
        // Prepare template IDs for the request
        var templateParams = selectedTemplates.map(id => `template_ids[]=${id}`).join('&');
        
        $.get('/batch-placeholders?' + templateParams, function(data) {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Build the form
            var placeholdersHtml = '';
            data.placeholders.forEach(function(placeholder) {
                var fieldId = placeholder.replace(/[^a-zA-Z0-9]/g, '_');
                var fieldLabel = placeholder.replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                placeholdersHtml += `
                    <div class="col-md-6">
                        <label for="${fieldId}" class="form-label" style="color: rgba(255,255,255,0.85); font-weight: 500;">
                            ${fieldLabel}
                        </label>`;
                
                if (placeholder.toLowerCase().includes('date')) {
                    placeholdersHtml += `
                        <input type="date" class="form-control" id="${fieldId}" name="${placeholder}" 
                               style="background: rgba(15, 23, 42, 0.8);" required>`;
                } else {
                    placeholdersHtml += `
                        <input type="text" class="form-control" id="${fieldId}" name="${placeholder}" 
                               placeholder="Enter ${fieldLabel.toLowerCase()}"
                               style="background: rgba(15, 23, 42, 0.8);" required>`;
                }
                
                placeholdersHtml += `
                        <div class="invalid-feedback">Please provide ${fieldLabel.toLowerCase()}.</div>
                    </div>`;
            });
            
            $('#placeholders_container').html(placeholdersHtml);
            
            // Build templates summary
            var summaryHtml = '<div class="row">';
            data.templates.forEach(function(template, index) {
                summaryHtml += `
                    <div class="col-md-6 mb-2">
                        <small class="text-muted">
                            <strong>${template.name}</strong> 
                            <span class="badge ms-1" style="background: linear-gradient(45deg, #6dd5ed, #2a8bf2); font-size: 0.65rem;">
                                ${template.type.charAt(0).toUpperCase() + template.type.slice(1)}
                            </span>
                        </small>
                    </div>`;
            });
            summaryHtml += '</div>';
            $('#templates_summary').html(summaryHtml);
            
            $('#form_container').show();
            
        }).fail(function() {
            alert('Failed to load placeholders');
        }).always(function() {
            $('#load_placeholders_btn').prop('disabled', false).html('Load Combined Form');
        });
    });
    
    // Form validation
    $('#batch_form').on('submit', function(e) {
        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            
            // Animate invalid fields
            $(this).find('.form-control:invalid').each(function() {
                $(this).css('animation', 'shake 0.4s cubic-bezier(0.4, 0, 0.2, 1)');
                setTimeout(() => $(this).css('animation', ''), 500);
            });
        } else {
            // Show loading state
            $(this).find('button[type="submit"]').prop('disabled', true).html(
                '<span class="spinner-border spinner-border-sm me-2"></span>Generating Documents...'
            );
        }
        $(this).addClass('was-validated');
    });
});

function clearForm() {
    $('#batch_form')[0].reset();
    $('#batch_form').removeClass('was-validated');
}

// Add shake animation
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        50% { transform: translateX(8px); }
        75% { transform: translateX(-4px); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}